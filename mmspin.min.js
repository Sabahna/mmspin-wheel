import {
    basePath,
    callBackUrl,
    campaignAPIKey,
    couponData,
    dataAPIKey,
    disagreeUrl,
    initUserForm,
    promotions,
    setCallBackUrl,
    setCampaign,
    setCoupon,
    setDisagreeUrl,
    setPromo,
    setTnc,
    setUserFormInit,
} from './constant/base.mjs';
import {
    agreeButton,
    disagreeButton,
    homeButton,
    mmspinCodeInput,
    mmspinCouponCodeSubtitle,
    mmspinCouponCodeTitle,
    mmspinMobileInput,
    mmspinRecaptchaInput,
    mmspinTabTcContainer,
    mmspinTouchMessage,
    mmspinWinningContainer,
    mmspinWinningCouponContainer,
    mmspinWinningItemContainer,
    mmspinWinningItemImg,
    mmspinWinningItemSubtitle,
    mmspinWinningItemTitle,
    wheelContainer,
} from './constant/constant.mjs';
import {createTCForm} from './module/tcn.mjs';
import {createUserForm} from './module/userform.mjs';
import {createWheel} from './module/wheel.mjs';
import {
    checkPhoneNumber,
    clearInput,
    sendUserData,
    spin,
} from './service/service.mjs';

$(document).ready(function () {
    function stepper(step) {
        switch (step) {
            case 1:
                createTCForm();

                // agree button action
                $('#agree').click(function () {
                    stepper(2);
                    $(mmspinTabTcContainer).css('display', 'none');
                    $(disagreeButton).css('display', 'none');
                });

                // disagree button action
                if (disagreeUrl) {
                    $(disagreeButton).click(function () {
                        window.location.replace(disagreeUrl);
                    });
                } else {
                    $(disagreeButton).click(function () {
                        window.location.href = '';
                    });
                }
                break;
            case 2:
                if (initUserForm) {
                    createUserForm();
                }

                // previous button action
                $('#previous').click(function () {
                    $(mmspinTabTcContainer).empty();
                    setUserFormInit(true);
                    clearInput();
                    stepper(1);
                });

                // next button action
                $('#next')
                    .unbind('click')
                    .bind('click', function () {
                        var mobileValue = $(mmspinMobileInput).val();
                        var gCaptcha = $(mmspinRecaptchaInput).val();

                        if (mobileValue === '') {
                            $(mmspinMobileInput).css({
                                border: '1px solid red',
                            });
                            return;
                        }

                        if (gCaptcha === '') {
                            return;
                        }

                        $('.mmspin_loading').css('display', 'block');

                        checkPhoneNumber(mobileValue, gCaptcha).then(
                            (response) => {
                                if (response) {
                                    $('.mmspin_loading').css(
                                        'display',
                                        'none'
                                    );
                                    $('#next').unbind('click');
                                    $(agreeButton).attr(
                                        'id',
                                        'submit'
                                    );

                                    $('#submit').click(function () {
                                        sendUserData().then(
                                            (response) => {
                                                if (response) {
                                                    setCoupon(
                                                        response.coupon
                                                    );

                                                    if (
                                                        $(
                                                            mmspinCodeInput
                                                        ).val() ===
                                                            response
                                                                .coupon
                                                                .code &&
                                                        response
                                                            .coupon
                                                            .promotion_id ===
                                                            null
                                                    ) {
                                                        stepper(3);
                                                    } else {
                                                        stepper(4);
                                                    }
                                                }
                                            }
                                        );
                                    });
                                }
                            }
                        );
                    });
                break;
            case 3:
                createWheel();
                $('#spin-btn').click(function () {
                    spin();
                });
                break;
            default:
                createWheel();
                let spinRotation = 0;
                let ramdomItem = promotions.findIndex(
                    (item) => item.id === couponData.promotion_id
                );

                let winningItem = promotions.find(
                    (item) => item.id === couponData.promotion_id
                );

                spinRotation =
                    (360 * (promotions.length - ramdomItem)) /
                        promotions.length +
                    2160;

                $('.wheel').css({
                    transform: `rotate(calc(1deg * ${spinRotation}))`,
                    transition: '12s',
                });

                $(mmspinWinningCouponContainer).append(
                    mmspinCouponCodeTitle,
                    mmspinCouponCodeSubtitle
                );
                $(mmspinCouponCodeSubtitle).text(couponData.code);

                let imagePath = basePath + winningItem.image;
                $(mmspinWinningItemImg).attr('src', imagePath);

                $(mmspinWinningItemSubtitle).text(
                    winningItem.description
                );

                winningItem.image
                    ? $(mmspinWinningItemContainer).append(
                          mmspinWinningItemTitle,
                          mmspinWinningItemImg,
                          mmspinWinningItemSubtitle,
                          homeButton
                      )
                    : $(mmspinWinningItemContainer).append(
                          mmspinWinningItemTitle,
                          mmspinWinningItemSubtitle,
                          homeButton
                      );

                $(mmspinWinningContainer).append(
                    mmspinWinningCouponContainer,
                    mmspinWinningItemContainer
                );

                $(wheelContainer).append(mmspinWinningContainer);

                $(mmspinTouchMessage).css('display', 'none');

                $(homeButton).click(function (a) {
                    window.location.href = callBackUrl;
                });

                break;
        }
    }

    $(function () {
        $.ajax({
            url: 'https://mmspin.com/api/mmspin/campaign',
            type: 'POST',
            dataType: 'json',
            contentType: 'application/json; charset=utf-8',
            data: JSON.stringify({
                campaign_api_key: campaignAPIKey,
                client_api_key: dataAPIKey,
            }),
            success: function (response) {
                setTnc(response[0].terms_and_conditions);
                setPromo(response[0].promotions);
                setCampaign(response[0]);
                setDisagreeUrl(response[0].disagree_url ?? '');
                setCallBackUrl(response[0].callback_url ?? '');
                stepper(1, response[0]);
                $('body').append(`<script
                src="https://www.google.com/recaptcha/api.js" async defer></script>`);
            },
            error: function (a) {
                console.log(a);
            },
        });
    });
});
